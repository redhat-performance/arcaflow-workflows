input:
  root: RootObject
  objects:
    SysbenchParams:
      id: SysbenchParams
      properties:
        threads:
          display:
            description: The number of threads sysbench will run
            name: sysbench threads
          type:
            type_id: integer
        time:
          display:
            description: The maximum runtime in seconds for the sysbench tests
            name: sysbench max runtime seconds
          type:
            type_id: integer
        percentile:
          display:
            description: The percentile to report latency metrics
            name: sysbench latency percentile
          type:
            type_id: integer
        cpu-max-prime:
          display:
            description: The upper limit of the number of prime numbers generated
            name: sysbench cpu max primes
          type:
            type_id: integer
    RootObject:
      id: RootObject
      properties:
        run_id:
          display:
            description: A unique run identifier for tracking groups of workflows triggered by external automation/CI
            name: Run ID
          type:
            type_id: string
          default: "\"\""
          required: false
        user:
          display:
            description: A user name identifier for tracking groups of workflows triggered by external automation/CI
            name: User
          type:
            type_id: string
          default: "\"\""
          required: false
        # sysbench_workload:
        #   display:
        #     description: The sysbench workload to run
        #     name: sysbench workload
        #   type:
        #     type_id: string
        #     # default: sysbenchcpu
        #   required: true
        sysbench_tests:
          type:
            type_id: list
            items:
              type_id: object
              id: SysbenchTests
              properties:
                sysbench_params:
                  type:
                    type_id: ref
                    id: SysbenchParams

steps:
  uuidgen:
    plugin: quay.io/arcalot/arcaflow-plugin-utilities:0.2.0
    step: uuid
    input: {}
  system_config:
    plugin: quay.io/arcalot/arcaflow-plugin-metadata:0.1.0
    input: {}
  sysbench_loop:
    kind: foreach
    items: !expr $.input.sysbench_tests
    workflow: sysbench-cpu.yaml
    parallelism: 1

outputs:
  success:
    uuid: !expr $.steps.uuidgen.outputs.success.uuid
    run_id: !expr $.input.run_id
    user: !expr $.input.user
    system_config: !expr $.steps.system_config.outputs.success
    sysbench: !expr $.steps.sysbench_loop.outputs.success
